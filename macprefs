#!/usr/bin/env python3
import argparse
import sys
import logging as log
import config
from version import __version__
import dotfiles
import preferences
import shared_file_lists
import system_preferences
import ssh_files
import startup_items
import app_store_preferences
import internet_accounts
import git_config
import cloud_credentials
import gpg_keys
import package_managers
import vscode_settings
import env_configs
import jetbrains_settings
import custom_fonts
import applications_list
import runtime_versions
import alfred_settings
import sublime_settings
import restore_readme

preference_choices = [
    'system_preferences',
    'startup_items',
    'dotfiles',
    'shared_file_lists',
    'ssh_files',
    'preferences',
    'app_store_preferences',
    'internet_accounts',
    'git_config',
    'cloud_credentials',
    'gpg_keys',
    'package_managers',
    'vscode_settings',
    'env_configs',
    'jetbrains_settings',
    'custom_fonts',
    'applications_list',
    'runtime_versions',
    'alfred_settings',
    'sublime_settings'
]

def backup(choices=[]):
    if not choices or 'system_preferences' in choices:
        system_preferences.backup()
    if not choices or 'startup_items' in choices:
        startup_items.backup()
    if not choices or 'dotfiles' in choices:
        dotfiles.backup()
    if not choices or 'shared_file_lists' in choices:
        shared_file_lists.backup()
    if not choices or 'ssh_files' in choices:
        ssh_files.backup()
    if not choices or 'preferences' in choices:
        preferences.backup()
    if not choices or 'app_store_preferences' in choices:
        app_store_preferences.backup()
    if not choices or 'internet_accounts' in choices:
        internet_accounts.backup()
    if not choices or 'git_config' in choices:
        git_config.backup()
    if not choices or 'cloud_credentials' in choices:
        cloud_credentials.backup()
    if not choices or 'gpg_keys' in choices:
        gpg_keys.backup()
    if not choices or 'package_managers' in choices:
        package_managers.backup()
    if not choices or 'vscode_settings' in choices:
        vscode_settings.backup()
    if not choices or 'env_configs' in choices:
        env_configs.backup()
    if not choices or 'jetbrains_settings' in choices:
        jetbrains_settings.backup()
    if not choices or 'custom_fonts' in choices:
        custom_fonts.backup()
    if not choices or 'applications_list' in choices:
        applications_list.backup()
    if not choices or 'runtime_versions' in choices:
        runtime_versions.backup()
    if not choices or 'alfred_settings' in choices:
        alfred_settings.backup()
    if not choices or 'sublime_settings' in choices:
        sublime_settings.backup()

    # Generate restore guide
    restore_readme.generate_readme()

    print('Backup Complete.')
    print('Backup saved to: ' + config.get_macprefs_dir())
    print('Restore guide: ' + config.get_macprefs_dir() + '/RESTORE.md')


def restore(choices=[]):
    if not choices or 'system_preferences' in choices:
        system_preferences.restore()
    if not choices or 'startup_items' in choices:
        startup_items.restore()
    if not choices or 'dotfiles' in choices:
        dotfiles.restore()
    if not choices or 'shared_file_lists' in choices:
        shared_file_lists.restore()
    if not choices or 'ssh_files' in choices:
        ssh_files.restore()
    if not choices or 'preferences' in choices:
        preferences.restore()
    if not choices or 'app_store_preferences' in choices:
        app_store_preferences.restore()
    if not choices or 'internet_accounts' in choices:
        internet_accounts.restore()
    if not choices or 'git_config' in choices:
        git_config.restore()
    if not choices or 'cloud_credentials' in choices:
        cloud_credentials.restore()
    if not choices or 'gpg_keys' in choices:
        gpg_keys.restore()
    if not choices or 'package_managers' in choices:
        package_managers.restore()
    if not choices or 'vscode_settings' in choices:
        vscode_settings.restore()
    if not choices or 'env_configs' in choices:
        env_configs.restore()
    if not choices or 'jetbrains_settings' in choices:
        jetbrains_settings.restore()
    if not choices or 'custom_fonts' in choices:
        custom_fonts.restore()
    if not choices or 'applications_list' in choices:
        applications_list.restore()
    if not choices or 'runtime_versions' in choices:
        runtime_versions.restore()
    if not choices or 'alfred_settings' in choices:
        alfred_settings.restore()
    if not choices or 'sublime_settings' in choices:
        sublime_settings.restore()

    print('Restore Complete.')


def invoke_func(args):
    if args.func is not None:
        if args.name == 'backup' or args.name == 'restore':
            args.func(args.t)
        else:
            args.func()


def configure_logging(verbose):
    if verbose > 0:
        log.basicConfig(format="%(message)s", level=log.DEBUG)
        log.debug('Verbose logging enabled')
    else:
        log.basicConfig(format="%(message)s", level=log.INFO)


def main():
    backup_dir = config.get_macprefs_dir()
    parser = argparse.ArgumentParser(
        prog='macprefs', description='backup and restore mac system preferences')
    parser.add_argument('--version', action='version', version=__version__)
    parser.add_argument('--verbose', '-v', action='count', help='log everything to the console')
    
    subparsers = parser.add_subparsers(title='commands', metavar='')

    backup_parser = subparsers.add_parser(
        'backup', help='backup preferences to ' + backup_dir)
    backup_parser.set_defaults(name='backup', func=backup)
    backup_parser.add_argument('-t', nargs='*', metavar='type', help='preferences you want to backup', choices=preference_choices, action="extend")

    restore_parser = subparsers.add_parser(
        'restore', help='restore preferences from ' + backup_dir)
    restore_parser.set_defaults(name='restore', func=restore)
    restore_parser.add_argument('-t', nargs='*', metavar='type', help='preferences you want to restore', choices=preference_choices, action="extend")

    if len(sys.argv) == 1:
        parser.print_help()
        sys.exit(0)
    args = parser.parse_args()
    verbosity = 0 if args.verbose is None else args.verbose
    configure_logging(verbosity)
    invoke_func(args)


if __name__ == '__main__':
    main()
